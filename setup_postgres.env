"""
Setup PostgreSQL database with initial data
Run this once after deploying to production
"""

import os
from create_app import create_app
from extensions import db
from models import Car, CarCategory

def setup_database():
    """Set up PostgreSQL database with tables and initial data"""
    app = create_app()
    
    with app.app_context():
        print("Creating database tables...")
        
        # Create all tables
        db.create_all()
        
        # Check if data already exists
        existing_cars = Car.query.count()
        if existing_cars > 0:
            print(f"Database already has {existing_cars} cars. Skipping seed data.")
            return
        
        print("Seeding database with initial data...")
        
        # Create car categories
        categories = [
            CarCategory(id=1, title='Economy', image='/assets/economy.png', 
                       description='Chevy Cruze, Kia Forte, Ford Focus', rate=70),
            CarCategory(id=2, title='Sedan', image='/assets/sedan.png', 
                       description='Ford Fusion', rate=80),
            CarCategory(id=3, title='Van', image='/assets/van.png', 
                       description='Dodge Caravan, Chevy Orlando', rate=120),
            CarCategory(id=4, title='SUV', image='/assets/suv.png', 
                       description='Dodge Journey', rate=90),
            CarCategory(id=5, title='Luxury', image='/assets/luxury.png', 
                       description='Suburban, Lincoln MKT, Audi Q7', rate=165)
        ]
        
        # Create cars
        cars = [
            Car(name="Ford Focus", model="2023", category="Economy", price_per_day=70, quantity=3),
            Car(name="Chevy Cruze", model="2023", category="Economy", price_per_day=70, quantity=3),
            Car(name="Kia Forte", model="2023", category="Economy", price_per_day=70, quantity=1),
            Car(name="Ford Fusion", model="2023", category="Sedan", price_per_day=80, quantity=2),
            Car(name="Dodge Caravan", model="2023", category="Van", price_per_day=120, quantity=3),
            Car(name="Chevy Orlando", model="2023", category="Van", price_per_day=120, quantity=1),
            Car(name="Dodge Journey", model="2023", category="SUV", price_per_day=90, quantity=8),
            Car(name="Suburban", model="2023", category="Luxury", price_per_day=165, quantity=1),
            Car(name="Lincoln MKT", model="2023", category="Luxury", price_per_day=165, quantity=1),
            Car(name="Audi Q7", model="2023", category="Luxury", price_per_day=165, quantity=1),
        ]
        
        # Add to database
        for category in categories:
            db.session.add(category)
        
        for car in cars:
            db.session.add(car)
        
        try:
            db.session.commit()
            print(f"✅ Successfully seeded database with {len(cars)} cars and {len(categories)} categories")
        except Exception as e:
            db.session.rollback()
            print(f"❌ Error seeding database: {e}")
            raise

if __name__ == "__main__":
    setup_database()